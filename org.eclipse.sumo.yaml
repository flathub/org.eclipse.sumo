app-id: org.eclipse.sumo
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '21.08' #openscenegraph still relie on older version of ffmpeg
command: sumo-gui
rename-icon: sumo
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
finish-args:
  - --share=ipc
  # - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --filesystem=home
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - '*.la'
  - '*.a'
modules:
  - shared-modules/glu/glu-9.json

  - name: GDAL
    buildsystem: cmake-ninja
    config-opts:
      - -DACCEPT_MISSING_SQLITE3_RTREE:BOOL=ON
    sources:
      - type: archive
        url: https://download.osgeo.org/gdal/3.6.0/gdal-3.6.0.tar.gz
        sha256: 0d6a79eec0c6afb97c7172e429ec05c9d15d3917987ad686a914b292c83531db
        x-checker-data:
          type: anitya
          project-id: 881
          stable-only: true
          url-template: https://download.osgeo.org/gdal/$version/gdal-$version.tar.gz
    modules:
      - name: PROJ
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_TESTING:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/OSGeo/PROJ/releases/download/9.1.0/proj-9.1.0.tar.gz
            sha256: 81b2239b94cad0886222cde4f53cb49d34905aad2a1317244a0c30a553db2315
            x-checker-data:
              type: anitya
              project-id: 9463
              stable-only: true
              url-template: https://github.com/OSGeo/PROJ/releases/download/$version/proj-$version.tar.gz

  - name: SWIG
    sources:
      - type: archive
        url: https://sourceforge.net/projects/swig/files/swig/swig-4.1.1/swig-4.1.1.tar.gz
        sha256: 2af08aced8fcd65cdb5cc62426768914bedc735b1c250325203716f78e39ac9b
        x-checker-data:
          type: anitya
          project-id: 4919
          stable-only: true
          url-template: https://sourceforge.net/projects/swig/files/swig/swig-$version/swig-$version.tar.gz

  - name: XercesC
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DBUILD_SHARED_LIBS=ON
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON
      - -Dnetwork-accessor=curl
      - -Dtranscoder=icu
    sources:
      - type: archive
        url: https://dlcdn.apache.org//xerces/c/3/sources/xerces-c-3.2.4.tar.xz
        sha256: 075bc57940da0f9be6dd183c550c8ce0b9833e4550dc382048377a1a5e3b2bd9
        x-checker-data:
          type: anitya
          project-id: 5182
          url-template: https://dlcdn.apache.org//xerces/c/3/sources/xerces-c-$version.tar.xz
  - name: gl2ps
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DOpenGL_GL_PREFERENCE=GLVND
    sources:
      - type: archive
        url: https://geuz.org/gl2ps/src/gl2ps-1.4.2.tgz
        sha256: 8d1c00c1018f96b4b97655482e57dcb0ce42ae2f1d349cd6d4191e7848d9ffe9
        x-checker-data:
          type: anitya
          project-id: 1173
          url-template: https://geuz.org/gl2ps/src/gl2ps-$version.tgz

  - name: fox
    buildsystem: autotools
    config-opts:
      - --disable-static
      - --enable-threadsafe
      - --enable-release
      - --enable-cups
      - --with-xft
      - --with-x
      - --with-xcursor
      - --with-xrender
      - --with-xrandr
      - --with-opengl
      - --with-shape
      - --with-xshm
    sources:
      - type: archive
        url: http://fox-toolkit.org/ftp/fox-1.6.57.zip
        sha256: 86ce8967094f03924e6801482dbe1de3a8de2edc41094fea8313c8524bc088a0
        x-checker-data:
          type: anitya
          project-id: 11427
          url-template: http://fox-toolkit.org/ftp/fox-$version.zip

  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'

  - name: openscenegraph
    buildsystem: cmake-ninja
    # build-options:
    #   cflags: -Wdeprecated-copy
    #   cxxflags: -Wdeprecated-copy
    # config-opts:
    #   # - -DCMAKE_BUILD_TYPE=Release
    #   - -DOSG_FIND_3RD_PARTY_DEPS=OFF
    sources:
      - type: archive
        url: https://github.com/openscenegraph/OpenSceneGraph/archive/OpenSceneGraph-3.6.5.tar.gz
        sha256: aea196550f02974d6d09291c5d83b51ca6a03b3767e234a8c0e21322927d1e12
        x-checker-data:
          type: anitya
          project-id: 6848
          stable-only: true
          url-template: https://github.com/openscenegraph/OpenSceneGraph/archive/OpenSceneGraph-$version.tar.gz

  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk17/install.sh
      - /usr/lib/sdk/openjdk17/installjdk.sh

  - name: SUMO
    buildsystem: cmake-ninja
    build-options:
    #   cflags: -fpermissive
    #   cxxflags: -fpermissive
      env:
        LIBRARY_PATH: /app/lib:/usr/lib
        LD_LIBRARY_PATH: /app/lib:/usr/lib
        PATH: /app/bin:/usr/bin:/usr/lib/sdk/openjdk17/bin
        JAVA_HOME: /usr/lib/sdk/openjdk17/jvm/openjdk-17
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DSUMO_UTILS:BOOL=true
      - -DFMI:BOOL=true
      - -DCHECK_OPTIONAL_LIBS:BOOL=true
      - -DENABLE_JAVA_BINDINGS=1
      - -DJava_JAVA_EXECUTABLE=/app/jre/bin
      - -DJava_JAR_EXECUTABLE=/app/jdk/bin
      - -DJava_JAVAC_EXECUTABLE=/app/jdk/bin
      - -DJava_JAVADOC_EXECUTABLE=/app/jdk/bin
      - -DJava_JAVAH_EXECUTABLE=/app/jdk/bin
      - -DJAVA_JVM_LIBRARY=/app/jre/lib
      - -DJAVA_INCLUDE_PATH=/app/jdk/include
      - -DJAVA_INCLUDE_PATH2=/app/jdk/include/linux
      - -DJAVA_AWT_INCLUDE_PATH=/app/jdk/include
      - -DMVN_EXECUTABLE=
    post-install:
      - install -Dm0644  -t ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/ build/package/sumo.png
      - install -Dm0644 build/package/sumo.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm0644 build/package/sumo.xml ${FLATPAK_DEST}/share/mime/application/${FLATPAK_ID}.xml
      - install -Dm0644 build/package/sumo.metainfo.xml ${FLATPAK_DEST}/share/metainfo/org.eclipse.sumo.metainfo.xml
    sources:
      - type: archive
        url: https://github.com/eclipse/sumo/archive/refs/tags/v1_15_0.tar.gz
        sha256: 9c96f79017483d9f9fb076a998f8df177520505567741100609d2e3651457fff
        x-checker-data:
          type: anitya
          project-id: 241872
          stable-only: true
          url-template: https://github.com/eclipse/sumo/archive/refs/tags/v$version.tar.gz
