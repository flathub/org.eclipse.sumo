app-id: org.eclipse.sumo
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '24.08'
command: sumo-gui
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
finish-args:
  - --share=ipc
  - --share=network  # for the osmWebWizard
  - --socket=x11
  - --device=dri
  - --filesystem=home
  - --env=SUMO_HOME=/app/share/sumo #https://github.com/flathub/org.eclipse.sumo/issues/64
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - '*.la'
  - '*.a'
modules:
  - shared-modules/glu/glu-9.json

  - name: GDAL
    buildsystem: cmake-ninja
    config-opts:
      - -DACCEPT_MISSING_SQLITE3_RTREE:BOOL=ON
    sources:
      - type: archive
        url: https://download.osgeo.org/gdal/3.12.0/gdal-3.12.0.tar.gz
        sha256: 44c95baabe6c1a047c1ebe5043e38dd73e4936bc4c481db14efbfd03342eab73
        x-checker-data:
          type: anitya
          project-id: 881
          stable-only: true
          url-template: https://download.osgeo.org/gdal/$version/gdal-$version.tar.gz
    modules:
      - name: PROJ
        buildsystem: cmake-ninja
        config-opts:
          - -DBUILD_TESTING:BOOL=OFF
        sources:
          - type: archive
            url: https://github.com/OSGeo/PROJ/releases/download/9.7.0/proj-9.7.0.tar.gz
            sha256: 65705ecd987b50bf63e15820ce6bd17c042feaabda981249831bd230f6689709
            x-checker-data:
              type: anitya
              project-id: 9463
              stable-only: true
              url-template: https://github.com/OSGeo/PROJ/releases/download/$version/proj-$version.tar.gz

  - name: SWIG
    sources:
      - type: archive
        url: https://sourceforge.net/projects/swig/files/swig/swig-4.4.0/swig-4.4.0.tar.gz
        sha256: c3f8e5dcd68c18aa19847b33b0a1bb92f07e904c53ae9cf5ae4ff8727a72927e
        x-checker-data:
          type: anitya
          project-id: 4919
          stable-only: true
          url-template: https://sourceforge.net/projects/swig/files/swig/swig-$version/swig-$version.tar.gz

  - name: XercesC
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DCMAKE_POSITION_INDEPENDENT_CODE=ON
      - -Dnetwork-accessor=curl
      - -Dtranscoder=icu
    sources:
      - type: archive
        url: https://dlcdn.apache.org//xerces/c/3/sources/xerces-c-3.3.0.tar.xz
        sha256: a83e12af82dc4fea09c592979fdbb6f206eeaa968562d7d18a0a4dd032c51267
        x-checker-data:
          type: anitya
          project-id: 5182
          url-template: https://dlcdn.apache.org//xerces/c/3/sources/xerces-c-$version.tar.xz
        # From https://bugs.gentoo.org/931105
      - type: patch
        path: xerces1.patch

  - name: gl2ps
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DOpenGL_GL_PREFERENCE=GLVND
    sources:
      - type: archive
        url: https://geuz.org/gl2ps/src/gl2ps-1.4.2.tgz
        sha256: 8d1c00c1018f96b4b97655482e57dcb0ce42ae2f1d349cd6d4191e7848d9ffe9
        x-checker-data:
          type: anitya
          project-id: 1173
          url-template: https://geuz.org/gl2ps/src/gl2ps-$version.tgz

  - name: jupedsim
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    sources:
      - type: archive
        url: https://github.com/PedestrianDynamics/jupedsim/archive/refs/tags/v1.3.1.tar.gz
        sha256: 1057cc6385290d08997ad4dcbe2c6f7cdcfc50e8e541777fc03cefb0f9d00f30
        x-checker-data:
          type: anitya
          project-id: 386815
          url-template: https://github.com/PedestrianDynamics/jupedsim/archive/refs/tags/v$version.tar.gz

  - name: geos
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: http://download.osgeo.org/geos/geos-3.14.1.tar.bz2
        sha256: 3c20919cda9a505db07b5216baa980bacdaa0702da715b43f176fb07eff7e716
        x-checker-data:
          type: anitya
          project-id: 13493
          url-template: http://download.osgeo.org/geos/geos-$version.tar.bz2
          stable-only: true

  - name: arrow
    buildsystem: cmake-ninja
    build-options:
      env:
        ARROW_MIMALLOC_URL: cpp/thirdparty/mimalloc-v3.1.5.tar.gz
        ARROW_XSIMD_URL: cpp/thirdparty/xsimd-13.0.0.tar.gz
    subdir: cpp
    config-opts:
      - -DARROW_PARQUET=ON
    sources:
      - type: archive
        url: https://github.com/apache/arrow/archive/refs/tags/apache-arrow-22.0.0.tar.gz
        sha256: 8a95e6c7b9bec2bc0058feb73efe38ad6cfd49a0c7094db29b37ecaa8ab16051
        x-checker-data:
          type: anitya
          project-id: 20697
          url-template: https://github.com/apache/arrow/archive/refs/tags/apache-arrow-$version.tar.gz
          stable-only: true
      - type: file
        url: https://github.com/microsoft/mimalloc/archive/v3.1.5.tar.gz
        sha256: 1c6949032069d5ebea438ec5cedd602d06f40a92ddf0f0d9dcff0993e5f6635c
        dest: cpp/thirdparty/mimalloc-v3.1.5.tar.gz
      - type: file
        url: https://github.com/xtensor-stack/xsimd/archive/13.0.0.tar.gz
        sha256: 8bdbbad0c3e7afa38d88d0d484d70a1671a1d8aefff03f4223ab2eb6a41110a3
        dest: cpp/thirdparty/xsimd-13.0.0.tar.gz

  - name: fox
    buildsystem: autotools
    config-opts:
      - --disable-static
      - --enable-threadsafe
      - --enable-release
      - --enable-cups
      - --with-xft
      - --with-x
      - --with-xcursor
      - --with-xrender
      - --with-xrandr
      - --with-opengl
      - --with-shape
      - --with-xshm
    sources:
      - type: archive
        url: http://fox-toolkit.org/ftp/fox-1.6.57.zip
        sha256: 86ce8967094f03924e6801482dbe1de3a8de2edc41094fea8313c8524bc088a0
        x-checker-data:
          type: anitya
          project-id: 11427
          url-template: http://fox-toolkit.org/ftp/fox-$version.zip

  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/5.0.1/eigen-5.0.1.tar.bz2
        sha256: e4de6b08f33fd8b8985d2f204381408c660bffa6170ac65b68ae1bd3cd575c0a
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'

    #From org.flightgear.FlightGear.yaml
    #openscenegraph still relie on older version of ffmpeg
  - name: ffmpeg
    config-opts:
      - --enable-shared
      - --disable-static
      - --disable-doc
      - --disable-manpages
      - --disable-stripping
      - --disable-ffplay
      - --disable-ffprobe

      - --enable-gpl
      - --enable-version3
      - --enable-optimizations
      - --enable-postproc
      - --enable-pthreads
      - --enable-gnutls
      - --enable-libxcb-xfixes
      - --enable-opengl
      - --enable-vaapi
      - --enable-vdpau
      - --enable-zlib
      - --enable-bzlib
      - --enable-lzma

      - --enable-fontconfig
      - --enable-libfontconfig
      - --enable-libfreetype

      # copied from another manifest
      - --enable-avcodec
      - --enable-avfilter
      - --enable-avresample
      - --enable-libxml2
      - --enable-swscale

      - --enable-libxcb

      - --enable-protocol=file
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-4.3.6.tar.xz
        sha256: f4b173d4d5f539a3699ef13d12a92dd4778ba55c26be1f3dd8f901b98987cc62
      - type: patch
        path: ffmpeg-as-fix.patch
    cleanup:
      - /share/ffmpeg/examples

  - name: openscenegraph
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/openscenegraph/OpenSceneGraph/archive/OpenSceneGraph-3.6.5.tar.gz
        sha256: aea196550f02974d6d09291c5d83b51ca6a03b3767e234a8c0e21322927d1e12
        x-checker-data:
          type: anitya
          project-id: 6848
          stable-only: true
          url-template: https://github.com/openscenegraph/OpenSceneGraph/archive/OpenSceneGraph-$version.tar.gz

  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk17/install.sh
      - /usr/lib/sdk/openjdk17/installjdk.sh

  - name: SUMO
    buildsystem: cmake-ninja
    build-options:
      env:
        LIBRARY_PATH: /app/lib:/usr/lib
        LD_LIBRARY_PATH: /app/lib:/usr/lib
        PATH: /app/bin:/usr/bin:/usr/lib/sdk/openjdk17/bin
        JAVA_HOME: /usr/lib/sdk/openjdk17/jvm/openjdk-17
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DSUMO_UTILS:BOOL=true
      - -DJava_JAVA_EXECUTABLE=/app/jre/bin
      - -DJava_JAR_EXECUTABLE=/app/jdk/bin
      - -DJava_JAVAC_EXECUTABLE=/app/jdk/bin
      - -DJava_JAVADOC_EXECUTABLE=/app/jdk/bin
      - -DJava_JAVAH_EXECUTABLE=/app/jdk/bin
      - -DJAVA_JVM_LIBRARY=/app/jre/lib
      - -DJAVA_INCLUDE_PATH=/app/jdk/include
      - -DJAVA_INCLUDE_PATH2=/app/jdk/include/linux
      - -DJAVA_AWT_INCLUDE_PATH=/app/jdk/include
      - -DMVN_EXECUTABLE=
    post-install:
      - ln -s ../share/sumo/tools/osmWebWizard.py ${FLATPAK_DEST}/bin/osmWebWizard.py
      - install -Dm0644 -t ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/ build_config/package/*.png
      - install -Dm0644 -t ${FLATPAK_DEST}/share/applications/               build_config/package/*.desktop
      - install -Dm0644 -t ${FLATPAK_DEST}/share/mime/application/           build_config/package/${FLATPAK_ID}.xml
      - install -Dm0644 -t ${FLATPAK_DEST}/share/metainfo/                   build_config/package/${FLATPAK_ID}.metainfo.xml
    sources:
      - type: archive
        url: https://github.com/eclipse/sumo/archive/refs/tags/v1_25_0.tar.gz
        sha256: 7944f574288db2ec46648fa4b49fbff2023263b4562f6068e38e9b25b2059f9e
        x-checker-data:
          type: anitya
          project-id: 241872
          stable-only: true
          url-template: https://github.com/eclipse/sumo/archive/refs/tags/v$version.tar.gz
      - type: patch
        path: captions.patch
      - type: patch
        path: cmake_setup_py.patch
